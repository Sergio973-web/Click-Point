<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click Point - Gesti√≥n Comercial</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-3xl p-6 bg-white rounded-2xl shadow-lg">
    <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-2">Click Point</h1>
    <p class="text-center text-gray-600 text-lg mb-6">Sistema de Gesti√≥n Comercial</p>

    <div class="grid grid-cols-2 gap-6">
      <button onclick="mostrarFormulario('mercaderia')" class="bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl text-lg font-semibold">Ingreso Mercader√≠a</button>
      <button onclick="mostrarFormulario('venta')" class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl text-lg font-semibold">Venta</button>
      <button onclick="mostrarFormulario('gasto')" class="bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl text-lg font-semibold">Gastos</button>
      <button onclick="mostrarFormulario('consulta')" class="bg-gray-700 hover:bg-gray-800 text-white py-4 rounded-xl text-lg font-semibold">Consultas</button>
    </div>

    <div id="formulario" class="mt-10 hidden"></div>
  </div>

  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3x2yGgT_hkYV2UB6BY2fumB7THcyQRVE",
      authDomain: "clickpoint-59d0b.firebaseapp.com",
      databaseURL: "https://clickpoint-59d0b-default-rtdb.firebaseio.com",
      projectId: "clickpoint-59d0b",
      storageBucket: "clickpoint-59d0b.appspot.com",
      messagingSenderId: "1061481442398",
      appId: "1:1061481442398:web:2013f1e269490a702b18cf",
      measurementId: "G-EPG8547HT7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function mostrarFormulario(tipo) {
      const contenedor = document.getElementById("formulario");
      contenedor.classList.remove("hidden");

      if (tipo === "mercaderia") {
        contenedor.innerHTML = `
          <h2 class="text-2xl font-bold mb-4 text-blue-700">Ingreso de Mercader√≠a</h2>
          <form id="form-mercaderia" class="grid grid-cols-1 gap-4">
            <input class="border p-2 rounded" type="text" placeholder="IMEI" required>
            <input class="border p-2 rounded" type="text" placeholder="Modelo" required>
            <input class="border p-2 rounded" type="text" placeholder="Color" required>
            <input class="border p-2 rounded" type="text" placeholder="Duraci√≥n de bater√≠a">
            <input class="border p-2 rounded" type="text" placeholder="Precio de compra" required inputmode="decimal" pattern="[0-9]+([.,][0-9]{0,2})?">
            <input class="border p-2 rounded" type="text" placeholder="Precio de venta" required inputmode="decimal" pattern="[0-9]+([.,][0-9]{0,2})?">
            <input class="border p-2 rounded" type="date" required>
            <select class="border p-2 rounded">
              <option value="">Estado</option>
              <option value="nuevo">Nuevo</option>
              <option value="usado">Usado</option>
            </select>
            <textarea class="border p-2 rounded" placeholder="Observaciones..."></textarea>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Guardar</button>
          </form>
        `;
      } else if (tipo === "venta") {
        contenedor.innerHTML = `
          <h2 class="text-2xl font-bold mb-4 text-green-700">Venta</h2>
          <form id="form-venta" class="grid grid-cols-1 gap-4">
            <input class="border p-2 rounded" type="date" required>
            <input class="border p-2 rounded" type="text" placeholder="Nombre y Apellido" required>
            <input class="border p-2 rounded" type="text" placeholder="DNI" required>
            <input class="border p-2 rounded" type="text" id="imei-buscar" placeholder="IMEI" required>

            <div id="datos-celular" class="bg-gray-100 p-4 rounded hidden">
              <p><strong>Modelo:</strong> <span id="venta-modelo"></span></p>
              <p><strong>Color:</strong> <span id="venta-color"></span></p>
              <p><strong>Precio base:</strong> $<span id="venta-precio"></span></p>
            </div>

            <label>Bonificaci√≥n (%):
              <input class="border p-2 rounded w-full" type="number" id="bonificacion" value="0" min="0" max="100">
            </label>

            <p class="text-xl font-bold">Precio final: $<span id="precio-final">0</span></p>

            <label>Forma de pago:
              <select class="border p-2 rounded w-full" id="forma-pago" required>
                <option value="">Seleccionar</option>
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="tarjeta">Tarjeta de cr√©dito</option>
              </select>
            </label>

            <label>Moneda:
              <select class="border p-2 rounded w-full" id="moneda" required>
                <option value="ARS">Pesos</option>
                <option value="USD">D√≥lares</option>
              </select>
            </label>

            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded">Registrar Venta</button>
          </form>
        `;

        setTimeout(() => {
          const imeiInput = document.getElementById('imei-buscar');
          const bonificacionInput = document.getElementById('bonificacion');
          const precioSpan = document.getElementById('venta-precio');
          const modeloSpan = document.getElementById('venta-modelo');
          const colorSpan = document.getElementById('venta-color');
          const finalSpan = document.getElementById('precio-final');
          const datosCelular = document.getElementById('datos-celular');

          let precioBase = 0;

          imeiInput.addEventListener('blur', () => {
            const imei = imeiInput.value.trim();
            if (!imei) return;

            db.ref('mercaderia').orderByChild('imei').equalTo(imei).once('value', snapshot => {
              if (snapshot.exists()) {
                const data = Object.values(snapshot.val())[0];
                modeloSpan.textContent = data.modelo;
                colorSpan.textContent = data.color;
                precioBase = parseFloat(data.precioVenta);
                precioSpan.textContent = precioBase.toFixed(2);
                finalSpan.textContent = precioBase.toFixed(2);
                datosCelular.classList.remove('hidden');
              } else {
                alert('IMEI no encontrado en la base de mercader√≠a');
                datosCelular.classList.add('hidden');
              }
            });
          });

          bonificacionInput.addEventListener('input', () => {
            const bonif = parseFloat(bonificacionInput.value) || 0;
            const final = precioBase - (precioBase * bonif / 100);
            finalSpan.textContent = final.toFixed(2);
          });
        }, 100);
      } else if (tipo === "gasto") {
        contenedor.innerHTML = `
          <h2 class="text-2xl font-bold mb-4 text-red-700">Registrar Gasto</h2>
          <form id="form-gasto" class="grid grid-cols-1 gap-4">
            <input class="border p-2 rounded" type="date" required>
            <input class="border p-2 rounded" type="text" placeholder="Monto en pesos (ARS)" inputmode="decimal" pattern="[0-9]+([.,][0-9]{0,2})?">
            <input class="border p-2 rounded" type="text" placeholder="Monto en d√≥lares (USD)" inputmode="decimal" pattern="[0-9]+([.,][0-9]{0,2})?">
            <input class="border p-2 rounded" type="text" placeholder="¬øQui√©n realiz√≥ el gasto?" required>
            <textarea class="border p-2 rounded" placeholder="Descripci√≥n del gasto" required></textarea>
            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded">Guardar Gasto</button>
          </form>
        `;
      } else if (tipo === "consulta") {
        contenedor.innerHTML = `
          <h2 class="text-2xl font-bold mb-4 text-gray-700">Consultas</h2>
          <label class="block mb-4">
            <span class="text-gray-700">Seleccionar tipo:</span>
            <select id="tipo-consulta" class="border p-2 rounded w-full">
              <option value="mercaderia">Mercader√≠a</option>
              <option value="ventas">Ventas</option>
              <option value="gastos">Gastos</option>
            </select>
          </label>
          <div id="tabla-consultas" class="overflow-x-auto mt-4"></div>

          <!-- SECCI√ìN NUEVA PARA GANANCIAS -->
          <div class="mt-6 p-4 border-t border-gray-300">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Ganancia por Mes</h3>
            <label class="block mb-2 text-sm text-gray-700">Seleccionar Mes y A√±o:</label>
            <input type="month" id="mes-ganancia" class="border p-2 rounded mb-2" value="${new Date().toISOString().slice(0,7)}">
            <button onclick="verGananciasMensuales()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">Ver Ganancia</button>
            <div id="resultado-ganancia-mensual" class="mt-4 text-sm text-gray-800"></div>
          </div>
        `;

        document.getElementById('tipo-consulta').addEventListener('change', cargarConsulta);
        cargarConsulta();
      }
    }

    // Funci√≥n para normalizar y parsear n√∫mero decimal con coma o punto
    function parseDecimal(valor) {
      if (valor == null) return 0;
      valor = String(valor).trim().replace(',', '.');
      let num = parseFloat(valor);
      return isNaN(num) ? 0 : +num.toFixed(2);
    }


    document.addEventListener('submit', function(e) {
      if (e.target.id === 'form-mercaderia') {
        e.preventDefault();
        const f = e.target;
        const data = {
          imei: f[0].value,
          modelo: f[1].value,
          color: f[2].value,
          duracionBateria: f[3].value,
          precioCompra: parseDecimal(f[4].value),
          precioVenta: parseDecimal(f[5].value),
          fechaIngreso: f[6].value,
          estado: f[7].value,
          observaciones: f[8].value,
          creadoEn: new Date().toISOString()
        };
        db.ref('mercaderia').push(data);
        alert('üì¶ Mercader√≠a guardada con √©xito');
        f.reset();
      }

      if (e.target.id === 'form-venta') {
        e.preventDefault();
        const f = e.target;
        const venta = {
          fecha: f[0].value,
          cliente: f[1].value,
          dni: f[2].value,
          imei: f[3].value,
          modelo: document.getElementById('venta-modelo').textContent,
          color: document.getElementById('venta-color').textContent,
          precioBase: parseDecimal(document.getElementById('venta-precio').textContent),
          bonificacion: parseDecimal(document.getElementById('bonificacion').value),
          precioFinal: parseDecimal(document.getElementById('precio-final').textContent),
          formaPago: document.getElementById('forma-pago').value,
          moneda: document.getElementById('moneda').value,
          creadoEn: new Date().toISOString()
        };
        db.ref('ventas').push(venta);
        alert("‚úÖ Venta registrada con √©xito");
        f.reset();
        document.getElementById('datos-celular').classList.add('hidden');
      }

      if (e.target.id === 'form-gasto') {
        e.preventDefault();
        const f = e.target;
        const gasto = {
          fecha: f[0].value,
          montoPesos: parseDecimal(f[1].value),
          montoUSD: parseDecimal(f[2].value),
          quien: f[3].value,
          descripcion: f[4].value,
          creadoEn: new Date().toISOString()
        };
        db.ref('gastos').push(gasto);
        alert("üí∏ Gasto registrado con √©xito");
        f.reset();
      }
    });

    function cargarConsulta() {
      const tipo = document.getElementById("tipo-consulta").value;
      const tablaContenedor = document.getElementById("tabla-consultas");
      db.ref(tipo).limitToLast(10).once("value", snapshot => {
        if (!snapshot.exists()) {
          tablaContenedor.innerHTML = `<p class="text-gray-600">No hay datos para mostrar.</p>`;
          return;
        }

        const datos = Object.values(snapshot.val());
        const claves = Object.keys(datos[0]);

        let html = `<table class="min-w-full bg-white border border-gray-300">
          <thead><tr>${claves.map(c => `<th class="px-4 py-2 border">${c}</th>`).join("")}</tr></thead>
          <tbody>${datos.map(item => `
            <tr>${claves.map(clave => `<td class="px-4 py-2 border text-sm">${item[clave] ?? ''}</td>`).join("")}</tr>
          `).join("")}</tbody>
        </table>`;

        tablaContenedor.innerHTML = html;
      });
    }

    // NUEVA FUNCI√ìN PARA GANANCIAS MENSUALES
async function verGananciasMensuales() {
  const mesAnio = document.getElementById('mes-ganancia').value; // "YYYY-MM"
  if (!mesAnio) {
    alert("Selecciona un mes y a√±o v√°lidos.");
    return;
  }
  const inicio = mesAnio + "-01";
  const [year, month] = mesAnio.split("-");
  const nextMonth = (parseInt(month) + 1).toString().padStart(2, '0');
  const fin = (parseInt(month) === 12) ? (parseInt(year) + 1) + "-01-01" : year + "-" + nextMonth + "-01";

  // Obtener ventas, compras y gastos del mes de Firebase con promesas
  try {
    const ventasSnap = await db.ref('ventas').orderByChild('fecha').startAt(inicio).endBefore(fin).once('value');
    const comprasSnap = await db.ref('mercaderia').orderByChild('fechaIngreso').startAt(inicio).endBefore(fin).once('value');
    const gastosSnap = await db.ref('gastos').orderByChild('fecha').startAt(inicio).endBefore(fin).once('value');

    const ventas = ventasSnap.exists() ? ventasSnap.val() : {};
    const compras = comprasSnap.exists() ? comprasSnap.val() : {};
    const gastos = gastosSnap.exists() ? gastosSnap.val() : {};

    // Crear un mapa de IMEI -> precioCompra para buscar r√°pido precio compra
    const mapaCompras = {};
    Object.values(compras).forEach(c => {
      if (c.imei) {
        mapaCompras[c.imei] = parseDecimal(c.precioCompra);
      }
    });

    // Calcular ganancia por venta
    let gananciaTotal = 0;
    Object.values(ventas).forEach(v => {
      const precioVenta = parseDecimal(v.precioFinal || 0);
      const precioCompra = mapaCompras[v.imei] ?? 0;
      const ganancia = precioVenta - precioCompra;
      gananciaTotal += ganancia;
    });

    // Sumar todos los gastos del mes (sumar ambos montos en pesos y USD convertidos)
    let gastosTotalPesos = 0;
    let gastosTotalUSD = 0;
    Object.values(gastos).forEach(g => {
      gastosTotalPesos += parseDecimal(g.montoPesos || 0);
      gastosTotalUSD += parseDecimal(g.montoUSD || 0);
    });

    // Convertir USD a pesos (supon√© un tipo de cambio fijo, pod√©s obtenerlo din√°micamente si quer√©s)
    const tipoCambioUSD = 350; // ejemplo, cambiar seg√∫n corresponda
    const gastosTotal = gastosTotalPesos + gastosTotalUSD * tipoCambioUSD;

    const gananciaNeta = gananciaTotal - gastosTotal;

    document.getElementById('resultado-ganancia-mensual').textContent =
      `Ganancia neta en ${mesAnio}: $${gananciaNeta.toFixed(2)} (Ganancia: $${gananciaTotal.toFixed(2)} - Gastos: $${gastosTotal.toFixed(2)})`;

  } catch (error) {
    console.error("Error al calcular ganancias mensuales:", error);
    alert("Error al obtener los datos. Intente nuevamente.");
  }
}


  </script>
</body>
</html>
