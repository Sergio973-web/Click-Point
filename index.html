<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click Point - Gestión Comercial</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-3xl p-6 bg-white rounded-2xl shadow-lg">
    <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-2">Click Point</h1>
    <p class="text-center text-gray-600 text-lg mb-6">Sistema de Gestión Comercial</p>

    <div class="grid grid-cols-2 gap-6">
      <button onclick="mostrarFormulario('mercaderia')" class="bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl text-lg font-semibold">Ingreso Mercadería</button>
      <button onclick="mostrarFormulario('venta')" class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl text-lg font-semibold">Venta</button>
      <button onclick="mostrarFormulario('gasto')" class="bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl text-lg font-semibold">Gastos</button>
      <button onclick="mostrarFormulario('consulta')" class="bg-gray-700 hover:bg-gray-800 text-white py-4 rounded-xl text-lg font-semibold">Consultas</button>
      <button onclick="mostrarFormulario('ganancia')" class="bg-yellow-500 hover:bg-yellow-600 text-white py-4 rounded-xl text-lg font-semibold">Ganancias</button>
      <button onclick="mostrarFormulario('balance')" class="bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl text-lg font-semibold">
      Balance General
      </button>


    </div>

    <div id="formulario" class="mt-10 hidden"></div>
  </div>

  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3x2yGgT_hkYV2UB6BY2fumB7THcyQRVE",
      authDomain: "clickpoint-59d0b.firebaseapp.com",
      databaseURL: "https://clickpoint-59d0b-default-rtdb.firebaseio.com",
      projectId: "clickpoint-59d0b",
      storageBucket: "clickpoint-59d0b.appspot.com",
      messagingSenderId: "1061481442398",
      appId: "1:1061481442398:web:2013f1e269490a702b18cf",
      measurementId: "G-EPG8547HT7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

let precioBase = 0;
let precioBaseUSD = 0;

function mostrarFormulario(tipo) {
  const contenedor = document.getElementById("formulario");
  contenedor.classList.remove("hidden");

if (tipo === "mercaderia") {
  contenedor.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-blue-700">Ingreso de Mercadería</h2>
    <form id="form-mercaderia" class="grid grid-cols-1 gap-4">
      <input class="border p-2 rounded" type="text" id="imei" placeholder="IMEI" required>
      <input class="border p-2 rounded" type="text" id="modelo" placeholder="Modelo" required>
      <input class="border p-2 rounded" type="text" id="color" placeholder="Color" required>
      <input class="border p-2 rounded" type="text" id="duracion" placeholder="Duración de batería">

      <select id="moneda-compra" class="border p-2 rounded" required>
        <option value="">Moneda de compra</option>
        <option value="ARS">Pesos (ARS)</option>
        <option value="USD">Dólares (USD)</option>
      </select>

      <input class="border p-2 rounded" type="number" id="tasa-cambio" placeholder="Tasa de cambio USD a ARS" step="0.01" required>
      <input class="border p-2 rounded" type="number" id="precio-compra" placeholder="Precio de compra" step="0.01" required>
      <input class="border p-2 rounded" type="number" id="porcentaje-ganancia" placeholder="% de ganancia sugerido" step="1">
      <input class="border p-2 rounded" type="number" id="ganancia-fija" placeholder="Ganancia fija en USD" step="0.01">

      <input class="border p-2 rounded" type="number" id="precio-venta-ars" placeholder="Precio de venta sugerido ARS" step="0.01" required>
      <input class="border p-2 rounded" type="number" id="precio-venta-usd" placeholder="Precio de venta sugerido USD" step="0.01" required>

      <input class="border p-2 rounded" type="date" id="fecha" required>
      <select id="estado" class="border p-2 rounded">
        <option value="">Estado</option>
        <option value="nuevo">Nuevo</option>
        <option value="usado">Usado</option>
      </select>

      <textarea class="border p-2 rounded" id="observaciones" placeholder="Observaciones..."></textarea>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Guardar</button>
    </form>
  `;

  setTimeout(() => {
    const form = document.getElementById("form-mercaderia");

    const monedaSelect = document.getElementById("moneda-compra");
    const tasaCambioInput = document.getElementById("tasa-cambio");
    const porcentajeGananciaInput = document.getElementById("porcentaje-ganancia");
    const gananciaFijaInput = document.getElementById("ganancia-fija");
    const precioCompraInput = document.getElementById("precio-compra");
    const precioVentaARSInput = document.getElementById("precio-venta-ars");
    const precioVentaUSDInput = document.getElementById("precio-venta-usd");

    function calcularPrecioVentaSugerido() {
      const compra = parseFloat(precioCompraInput.value) || 0;
      const porcentaje = parseFloat(porcentajeGananciaInput.value) || 0;
      const gananciaFija = parseFloat(gananciaFijaInput.value) || 0;
      const tasa = parseFloat(tasaCambioInput.value) || 0;
      const moneda = monedaSelect.value;

      if (compra > 0 && tasa > 0 && moneda) {
        let ventaUSD = 0;

        if (gananciaFija > 0) {
          if (moneda === "USD") {
            ventaUSD = compra + gananciaFija;
          } else {
            // Si la compra es en ARS, convertimos a USD para sumar ganancia fija
            const compraUSD = compra / tasa;
            ventaUSD = compraUSD + gananciaFija;
          }
        } else {
          if (moneda === "USD") {
            ventaUSD = compra * (1 + porcentaje / 100);
          } else {
            const compraUSD = compra / tasa;
            ventaUSD = compraUSD * (1 + porcentaje / 100);
          }
        }

        const ventaARS = ventaUSD * tasa;

        precioVentaUSDInput.value = ventaUSD.toFixed(2);
        precioVentaARSInput.value = ventaARS.toFixed(2);
      }
    }

    // Listeners para recalcular precio cuando cambie cualquiera de los inputs
    precioCompraInput.addEventListener("input", calcularPrecioVentaSugerido);
    porcentajeGananciaInput.addEventListener("input", () => {
      gananciaFijaInput.value = ''; // Limpiar ganancia fija si se pone porcentaje
      calcularPrecioVentaSugerido();
    });
    gananciaFijaInput.addEventListener("input", () => {
      porcentajeGananciaInput.value = ''; // Limpiar porcentaje si se pone ganancia fija
      calcularPrecioVentaSugerido();
    });
    monedaSelect.addEventListener("change", calcularPrecioVentaSugerido);
    tasaCambioInput.addEventListener("input", calcularPrecioVentaSugerido);

    // Sin cambios: recalcula si escriben directamente precios sugeridos
    precioVentaARSInput.addEventListener("input", () => {
      if (monedaSelect.value === "ARS") {
        const precioARS = parseFloat(precioVentaARSInput.value) || 0;
        const tasa = parseFloat(tasaCambioInput.value) || 1;
        const precioUSD = precioARS / tasa;
        precioVentaUSDInput.value = precioUSD.toFixed(2);
      }
    });

    precioVentaUSDInput.addEventListener("input", () => {
      if (monedaSelect.value === "USD") {
        const precioUSD = parseFloat(precioVentaUSDInput.value) || 0;
        const tasa = parseFloat(tasaCambioInput.value) || 1;
        const precioARS = precioUSD * tasa;
        precioVentaARSInput.value = precioARS.toFixed(2);
      }
    });

    tasaCambioInput.addEventListener("input", () => {
      const tasa = parseFloat(tasaCambioInput.value) || 1;

      if (monedaSelect.value === "ARS") {
        const precioARS = parseFloat(precioVentaARSInput.value) || 0;
        const precioUSD = precioARS / tasa;
        precioVentaUSDInput.value = precioUSD.toFixed(2);
      } else if (monedaSelect.value === "USD") {
        const precioUSD = parseFloat(precioVentaUSDInput.value) || 0;
        const precioARS = precioUSD * tasa;
        precioVentaARSInput.value = precioARS.toFixed(2);
      }
    });

    calcularPrecioVentaSugerido();

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const imei = document.getElementById("imei").value.trim();
      const modelo = document.getElementById("modelo").value.trim();
      const color = document.getElementById("color").value.trim();
      const duracion = document.getElementById("duracion").value.trim();
      const monedaCompra = document.getElementById("moneda-compra").value;
      const tasaCambio = parseFloat(document.getElementById("tasa-cambio").value);
      const precioCompra = parseFloat(document.getElementById("precio-compra").value);
      const precioVentaARS = parseFloat(document.getElementById("precio-venta-ars").value);
      const precioVentaUSD = parseFloat(document.getElementById("precio-venta-usd").value);
      const fecha = document.getElementById("fecha").value;
      const estado = document.getElementById("estado").value;
      const observaciones = document.getElementById("observaciones").value.trim();

      // **Precio de compra en USD** (sin convertir a ARS)
      const precioCompraUSD = monedaCompra === 'USD' ? precioCompra : precioCompra / tasaCambio;

      // **Precio de compra en ARS** solo si es necesario
      const precioCompraEnARS = monedaCompra === 'USD' ? precioCompra * tasaCambio : precioCompra;

      // Verificación de que el IMEI no existe
      db.ref('mercaderia').orderByChild('imei').equalTo(imei).once('value', snapshot => {
        if (snapshot.exists()) {
          // Si ya existe un producto con el mismo IMEI, mostramos un mensaje de error
          alert('❌ El IMEI ya está registrado. Por favor, ingresa un IMEI diferente.');
          return;  // No continuar con el registro del producto
        }

        // Si no existe el IMEI, continuamos con el registro del producto
        const producto = {
          imei,
          modelo,
          color,
          duracionBateria: duracion,
          monedaCompra,
          tasaCambio,
          precioCompraUSD,  // Guardamos directamente en USD
          precioCompra: precioCompraEnARS,  // Guardamos el precio en ARS si es necesario
          precioVenta: precioVentaARS,
          precioVentaUSD: precioVentaUSD,
          fechaIngreso: fecha,
          estado,
          observaciones,
          creadoEn: new Date().toISOString()
        };

        // Guardamos el producto en Firebase
        db.ref('mercaderia').push(producto)
          .then(() => {
            alert('📦 Producto guardado correctamente.');
            form.reset();  // Limpiar el formulario
          })
          .catch(err => {
            alert('❌ Error al guardar el producto: ' + err.message);
          });
      });
    });

  }, 100);
}
 else if (tipo === "venta") {
  contenedor.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-green-700">Venta</h2>
    <form id="form-venta" class="grid grid-cols-1 gap-4">
      <input class="border p-2 rounded" type="date" required>
      <input class="border p-2 rounded" type="text" placeholder="Nombre y Apellido" required>
      <input class="border p-2 rounded" type="text" placeholder="DNI" required>
      <input class="border p-2 rounded" type="text" id="imei-buscar" placeholder="IMEI" required>
      <div id="lista-productos" class="border rounded p-2 max-h-40 overflow-auto hidden"></div>
      <div id="datos-celular" class="bg-gray-100 p-4 rounded hidden">
        <p><strong>Modelo:</strong> <span id="venta-modelo"></span></p>
        <p><strong>Color:</strong> <span id="venta-color"></span></p>
        <p><strong>Precio base en ARS:</strong> $<span id="venta-precio-ars"></span></p>
        <p><strong>Precio base en USD:</strong> $<span id="venta-precio-usd"></span></p>
        <p><strong>Tasa usada:</strong>
          <input type="number" id="tasa-cambio-venta" class="border p-1 rounded w-24" step="0.01" min="0" value="0">
        </p>
        <p><strong>Precio final sugerido:</strong> <span id="precio-final">0.00</span> <span id="precio-final-usd" class="text-gray-500 text-sm"></span></p>
        <p id="restante" class="text-sm font-semibold text-blue-700 mt-2"></p>
      </div>

      <label>Bonificación (%):
        <input class="border p-2 rounded w-full" type="number" id="bonificacion" value="0" min="0" max="100">
      </label>
      <label>Forma de pago:
        <select class="border p-2 rounded w-full" id="forma-pago" required>
          <option value="">Seleccionar</option>
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia</option>
          <option value="tarjeta">Tarjeta de crédito</option>
        </select>
      </label>
      <label>Moneda:
        <select id="moneda" class="border p-2 rounded w-full">
          <option value="ARS">Pesos</option>
          <option value="USD">Dólares</option>
          <option value="AMBOS">Pesos y Dólares</option>
        </select>
      </label>
      <label>Monto pagado en Pesos (ARS):
        <input class="border p-2 rounded w-full" type="number" id="monto-pesos" min="0" step="0.01" value="0">
      </label>
      <label>Monto pagado en Dólares (USD):
        <input class="border p-2 rounded w-full" type="number" id="monto-dolares" min="0" step="0.01" value="0">
      </label>
      <label>Observaciones:
        <textarea id="observaciones" class="border p-2 rounded w-full" rows="3" placeholder="Opcional..."></textarea>
      </label>

      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded">Registrar Venta</button>
    </form>
  `;

  setTimeout(() => {
    const imeiInput = document.getElementById('imei-buscar');
    const bonificacionInput = document.getElementById('bonificacion');
    const modeloSpan = document.getElementById('venta-modelo');
    const colorSpan = document.getElementById('venta-color');
    const precioSpanARS = document.getElementById('venta-precio-ars');
    const precioSpanUSD = document.getElementById('venta-precio-usd');
    const finalSpan = document.getElementById('precio-final');
    const finalSpanUSD = document.getElementById('precio-final-usd');
    const tasaCambioInput = document.getElementById('tasa-cambio-venta');
    const datosCelular = document.getElementById('datos-celular');
    const restanteSpan = document.getElementById('restante');
    const listaProductos = document.getElementById('lista-productos');

    let productoKey = null;
    let precioBaseARS = 0;
    let precioBaseUSD = 0;
    let precioCompraGlobal = 0;
    let tasaOriginalCompra = 1;
    let monedaCompra = 'ARS'; // ✅ Se declara acá

    let imeiTimeout;

    imeiInput.addEventListener('input', () => {
      clearTimeout(imeiTimeout);
      imeiTimeout = setTimeout(() => {
        const query = imeiInput.value.trim();
        if (!query) return;

        db.ref('mercaderia').orderByChild('imei')
          .startAt(query)
          .endAt(query + "\uf8ff")
          .once('value')
          .then(snapshot => {
            if (!snapshot.exists()) return;

            listaProductos.innerHTML = '';
            listaProductos.classList.remove('hidden');

            Object.entries(snapshot.val()).forEach(([key, prod]) => {
              const item = document.createElement('div');
              item.className = 'cursor-pointer p-1 hover:bg-gray-200';
              item.textContent = `${prod.modelo} - ${prod.color} - IMEI: ${prod.imei}`;
              item.addEventListener('click', () => {
                productoKey = key;
                modeloSpan.textContent = prod.modelo;
                colorSpan.textContent = prod.color;

                precioBaseARS = parseFloat(prod.precioVenta) || 0;
                precioBaseUSD = parseFloat(prod.precioVentaUSD) || 0;
                precioCompraGlobal = parseFloat(prod.precioCompra) || 0;
                tasaOriginalCompra = parseFloat(prod.tasaCambio) || 1;
                monedaCompra = prod.monedaCompra || 'ARS'; // ✅ Se obtiene de la DB
                // Aquí accedemos directamente al precioCompraUSDreal de Firebase
                const precioCompraUSD = parseFloat(prod.precioCompraUSD) || 0; // O usa prod.precioCompraUSD si ese es el campo adecuado

                console.log("Precio de Compra en USD Real:", precioCompraUSD); // Esto se debe ver en el console log

                precioSpanARS.textContent = precioBaseARS.toFixed(2);
                precioSpanUSD.textContent = precioBaseUSD.toFixed(2);
                tasaCambioInput.value = tasaOriginalCompra.toFixed(2);

                actualizarPrecioFinal();

                datosCelular.classList.remove('hidden');
                listaProductos.classList.add('hidden');
                listaProductos.innerHTML = '';
                imeiInput.value = prod.imei;
              });

              listaProductos.appendChild(item);
            });
          });
      }, 300);
    });

    function actualizarPrecioFinal() {
      const bonif = parseFloat(bonificacionInput.value) || 0;
      const tasaActual = parseFloat(tasaCambioInput.value) || 1;
      const tasaOriginal = tasaOriginalCompra || 1;

      let sugeridoPesos = precioBaseUSD * tasaActual * (1 - bonif / 100);
      let sugeridoUSD = sugeridoPesos / tasaOriginal;

      const montoPesos = parseFloat(document.getElementById('monto-pesos').value) || 0;
      const montoDolares = parseFloat(document.getElementById('monto-dolares').value) || 0;
      const totalPagadoUSD = montoDolares + (montoPesos / tasaActual);

      if (montoPesos === 0 && montoDolares === 0) {
        finalSpan.textContent = `$${sugeridoPesos.toFixed(2)} (sugerido)`;
        finalSpanUSD.textContent = `~ USD ${sugeridoUSD.toFixed(2)}`;
        restanteSpan.textContent = '';
      } else {
        finalSpan.textContent = `$${(montoPesos + montoDolares * tasaActual).toFixed(2)} (pagado)`;
        finalSpanUSD.textContent = `~ USD ${totalPagadoUSD.toFixed(2)}`;

        const faltanteUSD = precioBaseUSD - totalPagadoUSD;
        if (faltanteUSD > 0) {
          const faltaEnPesos = faltanteUSD * tasaActual;
          restanteSpan.textContent = `Faltan: USD ${faltanteUSD.toFixed(2)} o $${faltaEnPesos.toFixed(2)} para completar.`;
          restanteSpan.className = 'text-red-600 font-semibold';
        } else {
          restanteSpan.textContent = `Pago completo.`;
          restanteSpan.className = 'text-green-600 font-semibold';
        }
      }
    }

    bonificacionInput.addEventListener('input', actualizarPrecioFinal);
    document.getElementById('moneda').addEventListener('change', actualizarPrecioFinal);
    document.getElementById('monto-pesos').addEventListener('input', actualizarPrecioFinal);
    document.getElementById('monto-dolares').addEventListener('input', actualizarPrecioFinal);
    tasaCambioInput.addEventListener('input', actualizarPrecioFinal);

    document.getElementById('form-venta').addEventListener('submit', e => {
      e.preventDefault();

      const form = e.target;
      const fecha = form[0].value;
      const montoPesos = parseFloat(document.getElementById('monto-pesos').value) || 0;
      const montoDolares = parseFloat(document.getElementById('monto-dolares').value) || 0;
      const tasaCambio = parseFloat(tasaCambioInput.value) || 1;

      // **Obtenemos el precio de compra en USD desde Firebase**
      const productoRef = db.ref('mercaderia').child(productoKey);  // Producto clave
      productoRef.once('value')
        .then(snapshot => {
          const producto = snapshot.val();
          const precioCompraUSDreal = parseFloat(producto.precioCompraUSD) || 0;

          // **Calculamos la venta en dólares**
          const ventaEnDolares = montoDolares + (montoPesos / tasaCambio);

          // **Calcular la ganancia en dólares**
          const gananciaUSD = ventaEnDolares - precioCompraUSDreal;

          // **Agregamos el console log para verificar el cálculo de la ganancia en USD**
          console.log("Cálculo de ganancia en USD:");
          console.log("Monto en Pesos:", montoPesos);
          console.log("Monto en Dólares:", montoDolares);
          console.log("Tasa de Cambio:", tasaCambio);
          console.log("Precio de Compra en USD Real:", precioCompraUSDreal);
          console.log("Ganancia en USD:", gananciaUSD);

          const venta = {
            fecha,
            cliente: form[1].value.trim(),
            dni: form[2].value.trim(),
            imei: imeiInput.value.trim(),
            modelo: modeloSpan.textContent,
            color: colorSpan.textContent,
            bonificacion: parseFloat(bonificacionInput.value) || 0,
            moneda: document.getElementById('moneda').value,
            formaPago: document.getElementById('forma-pago').value,
            montoPesos,
            montoDolares,
            observaciones: document.getElementById('observaciones').value.trim(),
            creadoEn: new Date().toISOString(),

            // Guardamos el precio de compra en dólares y la ganancia en dólares
            precioCompra: precioCompraGlobal,
            precioCompraUSDreal: (() => {
            if (monedaCompra === 'USD') {
              // Si la compra fue en USD, guardamos el valor directamente en USD
              return parseFloat(precioCompraUSDreal).toFixed(2);  // En dólares
            } 
            if (monedaCompra === 'ARS' && tasaOriginalCompra > 0) {
              // Si la compra fue en pesos, lo convertimos a USD usando la tasa de cambio
              return (precioCompraGlobal / tasaOriginalCompra).toFixed(2);  // En dólares
            }
            return '';  // Si no hay información válida, devolvemos un valor vacío
          })(),

            tasaCambioVenta: tasaCambio,
            tasaCambioCompra: tasaOriginalCompra,
            monedaCompra: monedaCompra || 'ARS',

            // Ganancia en dólares
            ganancia: gananciaUSD.toFixed(2)
          };

          // Guardamos la venta en Firebase
          db.ref('ventas').push(venta)
            .then(() => db.ref('ganancias').child(fecha).once('value'))
            .then(snapshot => {
              const actual = parseFloat(snapshot.val()) || 0;
              return db.ref('ganancias').child(fecha).set(actual + gananciaUSD);
            })
            .then(() => productoKey && db.ref('mercaderia').child(productoKey).remove())
            .then(() => {
              alert("✅ Venta registrada con éxito");
              form.reset();
              datosCelular.classList.add('hidden');
              location.reload();
            })
            .catch(err => alert('❌ Error al guardar la venta: ' + err.message));
        })
        .catch(err => {
          alert("❌ Error al obtener los datos del producto: " + err.message);
        });
    });


  }, 100);

} else if (tipo === "gasto") {
        contenedor.innerHTML = `
          <h2 class="text-2xl font-bold mb-4 text-red-700">Registrar Gasto</h2>
          <form id="form-gasto" class="grid grid-cols-1 gap-4">
            <input class="border p-2 rounded" type="date" required>
            <input class="border p-2 rounded" type="text" placeholder="Monto en pesos (ARS)" inputmode="decimal" pattern="[0-9]+([.,][0-9]{0,2})?">
            <input class="border p-2 rounded" type="text" placeholder="Monto en dólares (USD)" inputmode="decimal" pattern="[0-9]+([.,][0-9]{0,2})?">
            <input class="border p-2 rounded" type="text" placeholder="¿Quién realizó el gasto?" required>
            <textarea class="border p-2 rounded" placeholder="Descripción del gasto" required></textarea>
            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded">Guardar Gasto</button>
          </form>
        `;
      } 
      else if (tipo === "consulta") {
        contenedor.innerHTML = `
          <h2 class="text-2xl font-bold mb-4 text-gray-700">Consultas</h2>

          <label class="block mb-2">
            <span class="text-gray-700">Seleccionar tipo:</span>
            <select id="tipo-consulta" class="border p-2 rounded w-full">
              <option value="mercaderia">Mercadería</option>
              <option value="ventas">Ventas</option>
              <option value="gastos">Gastos</option>
            </select>
          </label>

          <label class="block my-4">
            <span class="text-gray-700">Buscar:</span>
            <input
              type="text"
              id="filtro-consulta"
              placeholder="Filtrar por cualquier campo..."
              class="px-3 py-2 border rounded w-full"
              oninput="cargarConsulta()" />
          </label>

          <div id="tabla-consultas" class="overflow-x-auto mt-4"></div>
        `;

        document.getElementById('tipo-consulta').addEventListener('change', cargarConsulta);
        cargarConsulta();
      }
       else if (tipo === "ganancia") {
        contenedor.innerHTML = `
          <hr class="my-4">

          <h2 class="text-2xl font-bold mb-4 text-yellow-700">Ganancia por Rango de Días</h2>
          <label class="block mb-2 text-sm text-gray-700">Desde:</label>
          <input type="date" id="fecha-desde" class="border p-2 rounded mb-2">

          <label class="block mb-2 text-sm text-gray-700">Hasta:</label>
          <input type="date" id="fecha-hasta" class="border p-2 rounded mb-2">

          <button onclick="verGananciasPorRango()" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded">
            Ver Ganancia del Rango
          </button>

          <div id="resultado-ganancia-rango" class="mt-4 text-sm text-gray-800"></div>
        `;
      }

else if (tipo === "balance") {
  contenedor.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-purple-700">Balance General - Capital Inicial</h2>
    <form id="form-balance" class="grid grid-cols-1 gap-4">
      <label>
        Capital inicial en Pesos (ARS):
        <input type="number" min="0" step="0.01" class="border p-2 rounded w-full" id="capital-pesos" required>
      </label>
      <label>
        Capital inicial en Dólares (USD):
        <input type="number" min="0" step="0.01" class="border p-2 rounded w-full" id="capital-dolares" required>
      </label>
      <label>
        Tasa de cambio (USD a ARS):
        <input type="number" min="0" step="0.01" class="border p-2 rounded w-full" id="tasa-cambio" required>
      </label>
      <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded">Calcular Balance</button>
    </form>
    <div id="resultado-balance" class="mt-4 text-gray-800 text-lg font-semibold"></div>
  `;

  setTimeout(() => {
    // Cargar capital inicial
    db.ref('capitalInicial').once('value', snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        document.getElementById('capital-pesos').value = data.pesos || 0;
        document.getElementById('capital-dolares').value = data.dolares || 0;
        document.getElementById('tasa-cambio').value = data.tasaCambio || 0;
      }
    });

    const formBalance = document.getElementById('form-balance');
    formBalance.addEventListener('submit', async e => {
      e.preventDefault();

      const capitalPesos = parseFloat(document.getElementById('capital-pesos').value) || 0;
      const capitalDolares = parseFloat(document.getElementById('capital-dolares').value) || 0;
      const tasaCambio = parseFloat(document.getElementById('tasa-cambio').value) || 0;

      // Guardar capital inicial actualizado en Firebase
      await db.ref('capitalInicial').set({
        pesos: capitalPesos,
        dolares: capitalDolares,
        tasaCambio: tasaCambio
      });

      // Convertir capital inicial a ARS
      const capitalDolaresEnPesos = capitalDolares * tasaCambio;
      const capitalInicialTotalARS = capitalPesos + capitalDolaresEnPesos;

      // Obtener ganancias acumuladas (sumar todos los valores del nodo 'ganancias')
      const gananciasSnapshot = await db.ref('ganancias').once('value');
      let totalGanancias = 0;
      if (gananciasSnapshot.exists()) {
        const gananciasData = gananciasSnapshot.val();
        for (const dia in gananciasData) {
          totalGanancias += parseFloat(gananciasData[dia]) || 0;
        }
      }

      // Obtener gastos acumulados (sumar todos los valores del nodo 'gastos')
      // Aquí asumo que guardás los gastos de forma similar a ganancias, ejemplo:
      // gastos: { '2025-07-25': 5000, '2025-07-26': 2000, ... }
      const gastosSnapshot = await db.ref('gastos').once('value');
      let totalGastos = 0;
      if (gastosSnapshot.exists()) {
        const gastosData = gastosSnapshot.val();
        for (const dia in gastosData) {
          totalGastos += parseFloat(gastosData[dia]) || 0;
        }
      }

      // Calcular balance neto
      const balanceNeto = capitalInicialTotalARS + totalGanancias - totalGastos;

      // Mostrar resultado
      const resultadoDiv = document.getElementById('resultado-balance');
      resultadoDiv.innerHTML = `
        <p>Capital inicial total en ARS: $${capitalInicialTotalARS.toFixed(2)}</p>
        <p>Ganancias acumuladas: $${totalGanancias.toFixed(2)}</p>
        <p>Gastos acumulados: $${totalGastos.toFixed(2)}</p>
        <h3 class="mt-4 font-bold">Balance neto actual: $${balanceNeto.toFixed(2)}</h3>
      `;
    });
  }, 100);
}

}

    // Función para normalizar y parsear número decimal con coma o punto
    function parseDecimal(valor) {
      if (valor == null) return 0;
      valor = String(valor).trim().replace(',', '.');
      let num = parseFloat(valor);
      return isNaN(num) ? 0 : +num.toFixed(2);
    }


    document.addEventListener('submit', function(e) {
      
      

      if (e.target.id === 'form-gasto') {
        e.preventDefault();
        const f = e.target;
        const gasto = {
          fecha: f[0].value,
          montoPesos: parseDecimal(f[1].value),
          montoUSD: parseDecimal(f[2].value),
          quien: f[3].value,
          descripcion: f[4].value,
          creadoEn: new Date().toISOString()
        };
        db.ref('gastos').push(gasto);
        alert("💸 Gasto registrado con éxito");
        f.reset();
      }
    });

function cargarConsulta() {
  const tipo = document.getElementById("tipo-consulta").value;
  const filtroInput = document.getElementById("filtro-consulta");
  const filtro = filtroInput ? filtroInput.value.toLowerCase() : '';
  const tablaContenedor = document.getElementById("tabla-consultas");

  db.ref(tipo).limitToLast(100).once("value", snapshot => {
    if (!snapshot.exists()) {
      tablaContenedor.innerHTML = `<p class="text-gray-600">No hay datos para mostrar.</p>`;
      return;
    }

    const datos = snapshot.val();
    const entradas = Object.entries(datos);
    if (entradas.length === 0) {
      tablaContenedor.innerHTML = `<p class="text-gray-600">No hay entradas.</p>`;
      return;
    }

    // Obtener las claves de la primera entrada
    const claves = Object.keys(entradas[0][1]);

    

    // Filtrar las entradas basadas en el filtro de búsqueda
    const filtradas = entradas.filter(([_, item]) =>
      claves.some(clave =>
        String(item[clave] ?? '').toLowerCase().includes(filtro)
      )
    );

    if (filtradas.length === 0) {
      tablaContenedor.innerHTML = `<p class="text-gray-600">No se encontraron resultados para "${filtro}".</p>`;
      return;
    }

    // Crear la tabla HTML
    let html = `<table class="min-w-full bg-white border border-gray-300">
      <thead>
        <tr>
          ${claves.map(c => `<th class="px-4 py-2 border">${c}</th>`).join("")}
          <th class="px-4 py-2 border">Acciones</th>
        </tr>
      </thead>
      <tbody>
        ${filtradas.map(([key, item]) => `
          <tr>
            ${claves.map(clave => {
              // Comprobar y mostrar los valores de cada clave de los datos
              if (clave === "precioCompraUSDreal") {
                // Mostrar el valor de 'precioCompraUSDreal' al lado de 'precioCompra'
                const precioCompraUSD = item["precioCompraUSD"] || '';  // Asegúrate de que 'precioCompraUSD' sea el nombre correcto en Firebase
                return `<td class="px-4 py-2 border text-sm">${precioCompraUSD ? precioCompraUSD.toFixed(2) : ''}</td>`;
              } else if (clave === "tasaCambioVenta") {
                // Mostrar "Por definir" si 'tasaCambioVenta' no existe
                const tasaVenta = item["tasaCambioVenta"];
                return `<td class="px-4 py-2 border text-sm">${tasaVenta ? tasaVenta : 'Por definir'}</td>`;
              } else if (clave === "tasaCambioCompra") {
                // Mostrar tasa de compra si existe
                const tasaCompra = item["tasaCambioCompra"];
                return `<td class="px-4 py-2 border text-sm">${tasaCompra || ''}</td>`;
              } else {
                // Para las demás claves
                return `<td class="px-4 py-2 border text-sm">${item[clave] ?? ''}</td>`;
              }
            }).join("")}
            <td class="px-4 py-2 border text-center">
              <button onclick="editarItem('${tipo}', '${key}')" class="text-blue-600 hover:underline">✏️</button>
              <button onclick="eliminarItem('${tipo}', '${key}')" class="text-red-600 hover:underline ml-2">🗑️</button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>`;

    tablaContenedor.innerHTML = html;
  });
}


    // NUEVA FUNCIÓN PARA GANANCIAS MENSUALES
function verGananciasMensuales() {
  const mesAnio = document.getElementById('mes-ganancia').value; // formato "YYYY-MM"
  if (!mesAnio) {
    alert("Selecciona un mes y año válidos.");
    return;
  }
  const inicio = mesAnio + "-01";
  const [year, month] = mesAnio.split("-");
  const nextMonth = (parseInt(month) + 1).toString().padStart(2, '0');
  const fin = (parseInt(month) === 12) ? (parseInt(year) + 1) + "-01-01" : year + "-" + nextMonth + "-01";

  let mapaCompras = {};
  let gananciaBruta = 0;
  let gastosMes = 0;

  // Primero cargamos mercaderia para crear mapa IMEI -> precioCompra
  db.ref('mercaderia').once('value', snapshotMercaderia => {
    if (snapshotMercaderia.exists()) {
      snapshotMercaderia.forEach(child => {
        const item = child.val();
        if (item.imei) {
          mapaCompras[item.imei.trim().toUpperCase()] = parseDecimal(item.precioCompra);
        }
      });
    }

    // Luego cargamos ventas del mes
    db.ref('ventas').orderByChild('fecha').startAt(inicio).endBefore(fin).once('value', snapshotVentas => {
      if (snapshotVentas.exists()) {
        snapshotVentas.forEach(child => {
          const v = child.val();
          const imeiVenta = (v.imei || "").trim().toUpperCase();
          const precioVenta = parseDecimal(v.precioFinal || 0);

          if (!imeiVenta) {
            console.warn("Venta sin IMEI:", v);
            return;
          }
          if (!(imeiVenta in mapaCompras)) {
            console.warn(`No se encontró precio de compra para IMEI: ${imeiVenta}`);
            // Opcional: podrías descontar el precioVenta como pérdida, o ignorar esta venta
            return;
          }

          const precioCompra = mapaCompras[imeiVenta];
          gananciaBruta += precioVenta - precioCompra;
        });
      }

      // Finalmente, cargamos gastos del mes
      db.ref('gastos').orderByChild('fecha').startAt(inicio).endBefore(fin).once('value', snapshotGastos => {
        if (snapshotGastos.exists()) {
          snapshotGastos.forEach(child => {
            const g = child.val();
            gastosMes += parseDecimal(g.montoPesos) + parseDecimal(g.montoUSD) * tasaCambio; // Ejemplo: convertir USD a pesos (ajustar tasa)
          });
        }

        const gananciaNeta = gananciaBruta - gastosMes;
        document.getElementById('resultado-ganancia-mensual').textContent = 
          `Ganancia neta en ${mesAnio}: $${gananciaNeta.toFixed(2)} (Ganancia bruta: $${gananciaBruta.toFixed(2)} - Gastos: $${gastosMes.toFixed(2)})`;
      });
    });
  });
}

function eliminarItem(tipo, id) {
  if (confirm("¿Estás seguro que deseas eliminar este registro?")) {
    db.ref(`${tipo}/${id}`).remove().then(() => {
      alert("Elemento eliminado");
      cargarConsulta();
    });
  }
}

function editarItem(tipo, id) {
  db.ref(`${tipo}/${id}`).once("value", snapshot => {
    if (!snapshot.exists()) return alert("Elemento no encontrado");

    const datos = snapshot.val();
    const formulario = document.getElementById("formulario");

    formulario.innerHTML = `
      <h2 class="text-xl font-bold mb-4 text-blue-800">Editar ${tipo}</h2>
      <form id="form-edicion" class="grid grid-cols-1 gap-3">
        ${Object.entries(datos).map(([k, v]) => `
          <label class="text-sm">
            ${k}<br>
            <input name="${k}" class="border p-2 rounded w-full" value="${v ?? ''}" />
          </label>
        `).join("")}
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Guardar cambios</button>
      </form>
    `;

    document.getElementById("form-edicion").addEventListener("submit", function(e) {
      e.preventDefault();
      const inputs = Array.from(this.elements).filter(el => el.name);
      const actualizado = {};
      inputs.forEach(input => {
        actualizado[input.name] = input.value;
      });

      if (actualizado.precioCompra) actualizado.precioCompra = parseDecimal(actualizado.precioCompra);
      if (actualizado.precioVenta) actualizado.precioVenta = parseDecimal(actualizado.precioVenta);

      db.ref(`${tipo}/${id}`).set(actualizado).then(() => {
        alert("✅ Datos actualizados");
        mostrarFormulario("consulta");
      });
    });
  });
}


function calcularBalanceSeparado(capitalPesos, capitalDolares, tasaCambio) {
  // Guardar capital inicial actualizado en Firebase
  db.ref("capitalInicial").set({
    pesos: capitalPesos,
    dolares: capitalDolares
  });

  let ventasPesos = 0;
  let ventasDolares = 0;
  let gastosPesos = 0;
  let gastosDolares = 0;
  let totalCostoCompra = 0;

  let mapaCompra = {};

  db.ref('mercaderia').once('value', snapshotMercaderia => {
    if (snapshotMercaderia.exists()) {
      snapshotMercaderia.forEach(child => {
        const item = child.val();
        if (item.imei) {
          mapaCompra[item.imei.trim().toUpperCase()] = parseDecimal(item.precioCompra);
        }
      });
    }

    db.ref('ventas').once('value', snapshotVentas => {
      if (snapshotVentas.exists()) {
        snapshotVentas.forEach(child => {
          const v = child.val();
          const imeiVenta = (v.imei || "").trim().toUpperCase();
          const precioFinal = parseDecimal(v.precioFinal) || 0;
          const moneda = (v.moneda || "ARS").toUpperCase();

          if (moneda === 'USD') {
            ventasDolares += precioFinal;
          } else {
            ventasPesos += precioFinal;
          }

          if (imeiVenta && mapaCompra[imeiVenta]) {
            totalCostoCompra += mapaCompra[imeiVenta];
          } else {
            console.warn(`No se encontró precioCompra para IMEI: ${imeiVenta}`);
          }
        });
      }

      db.ref('gastos').once('value', snapshotGastos => {
        if (snapshotGastos.exists()) {
          snapshotGastos.forEach(child => {
            const g = child.val();
            gastosPesos += parseDecimal(g.montoPesos);
            gastosDolares += parseDecimal(g.montoUSD);
          });
        }

        const capitalNetoPesos = capitalPesos + ventasPesos - gastosPesos - totalCostoCompra;
        const capitalNetoDolares = capitalDolares + ventasDolares - gastosDolares;

        const totalEnPesos = capitalNetoPesos + capitalNetoDolares * tasaCambio;

        const resultado = `
          <p>Dinero real en caja:</p>
          <ul>
            <li><strong>PESOS:</strong> $${capitalNetoPesos.toFixed(2)} ARS</li>
            <li><strong>DÓLARES:</strong> $${capitalNetoDolares.toFixed(2)} USD</li>
            <li><strong>Total aproximado en pesos:</strong> $${totalEnPesos.toFixed(2)} ARS (usando tasa $${tasaCambio})</li>
          </ul>
          <p class="mt-2 text-sm italic text-gray-600">(Capital inicial + Ventas - Gastos - Costo de Mercadería)</p>
        `;

        document.getElementById('resultado-balance').innerHTML = resultado;
      });
    });
  });
}


document.addEventListener('DOMContentLoaded', () => {
  const titulo = document.querySelector('h1');
  if (titulo) {
    titulo.style.cursor = 'pointer'; // opcional, para que se note que es clickeable
    titulo.addEventListener('click', () => {
      location.reload();
    });
  }
});

function verGananciasPorRango() {
  const fechaDesde = document.getElementById('fecha-desde').value;
  const fechaHasta = document.getElementById('fecha-hasta').value;

  if (!fechaDesde || !fechaHasta) {
    alert('Por favor, selecciona un rango de fechas válido.');
    return;
  }

  // Convertir las fechas a strings en formato YYYY-MM-DD
  const fechaInicio = fechaDesde;  // Ya están en el formato correcto
  const fechaFin = fechaHasta;  // Lo mismo

  const resultadoContenedor = document.getElementById('resultado-ganancia-rango');

  // Consultar las ganancias acumuladas en dólares por el rango de fechas
  db.ref('ganancias').orderByKey().startAt(fechaInicio).endAt(fechaFin + "\uf8ff").once('value', snapshot => {
    if (!snapshot.exists()) {
      resultadoContenedor.innerHTML = `<p class="text-gray-600">No se encontraron ganancias en dólares para este rango de fechas.</p>`;
      return;
    }

    let totalGananciaUSD = 0;
    snapshot.forEach(childSnapshot => {
      totalGananciaUSD += parseFloat(childSnapshot.val()) || 0;
    });

    resultadoContenedor.innerHTML = `
      <h3 class="text-lg font-semibold text-gray-700">Ganancia Total en Dólares en el Rango:</h3>
      <p class="text-gray-800">$${totalGananciaUSD.toFixed(2)}</p>
    `;
  });
}


  </script>
</body>
</html>
